# Static Typechecker

- Design decisions:
  - Primarily nominal, rather than structural.
  - The type system should aim to be sound - no type errors at runtime.
  - Nil is not assignable to another type. Types can be made nullable through unions with Nil.
  - Functions which do not declare a return type must not return a value.
  - The types of variables will be inferred, but not parameters or return types.
  - If a subclass overrides a method, the type of each parameter must match or be a superclass of the parameter's type in the original method.
  - Eventually, type guards using `isInstance` will allow narrowing union types.

- Roadmap:
  - [X] Add syntax support for type declarations for parameters, return types and variable declarations.
  - [X] Add classes for representing types within the typechecker.
  - [X] Find a way to define types for the initial globals.
  - [X] Adapt the resolver to perform basic typechecking for functions, variables and operators.
  - [X] Introduce separate namespaces for types and values.
  - [X] Modify scoping rules and typechecking order to allow mutual recursion.
  - [X] Add support for string concatenation (currently '+' only works on numbers).
  - [X] Add support for classes and subtyping.
  - [X] Allow classes to declare the types of their fields.
  - [X] Add syntax for declaring callable types.
  - [X] Only defer typechecking of top-level functions, to obey Lox scoping rules, while allowing mutually recursive functions at top-level.
  - Improve errors:
    - [X] Adapt AST to allow accessing the source location of any expression for type errors.
    - [X] Fix tests to use new error format.
    - [X] Use `rangeError` for scanner, parser and runtime errors.
    - [X] Refactor error reporting to avoid the scanner, parser, typechecker and interpreter needing access to the Lox instance.
  - [X] Sort errors by location in the source code, so the order is not affected by deferred checking.
  - [X] Rollback typechecker state after type error in the REPL, so it correctly reflects interpreter state.
  - [X] Add types for builtin type constructors (Boolean, Number, String).
  - [X] Ensure all code paths in a function return.
  - [X] Add support for union types.
    - [X] Add syntax for unions.
    - [X] Add basic class for unions.
    - [X] Move union and type compatibility methods out of type checker class.
    - [X] Implement type compatibility for unions.
    - [X] Implement construction for unions.
    - [X] Implement `.get` for unions.
    - [X] Implement callable unions.
  - [X] Add type aliases.
  - [ ] Add control-flow type refinement.
    - [X] Use narrowings in while statements.
    - [X] Use narrowings in logical expressions.
    - [X] Propagate narrowings through not operator.
    - [X] Propagate narrowings through logical expressions.
    - [X] Make comparisons to nil provide narrowings.
    - [X] Make variable expressions in boolean context provide narrowings e.g. `if (x}`
    - [X] Add a way for `isInstance` to provide narrowings.
    - [ ] Combine passability with narrowings.
      - [ ] Change scope cloning to happen at every branch point.
      - [ ] Apply control flow union for logical operators.
      - [ ] Apply control flow union for while loops.
    - [X] Fix unsoundness from narrowing applying to functions which may be called after reassignment.
    - [X] Allow assignment to unnarrowed type.
  - [ ] Add a `Never` type to allow expression statements to be impassable and reflect impossible narrowings.
  - [ ] Add generics.
